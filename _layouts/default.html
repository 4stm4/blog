<!doctype html>
<html lang="{{ site.lang | default: 'ru' }}">
{%- include head.html -%}

<body class="site-body">
  <a class="skip-link" href="#main-content">Перейти к содержимому</a>
  <header class="site-header">
    <div class="container-xl">
      <div class="header-inner">
        <a class="brand" href="{{ '/' | relative_url }}">
          <span class="material-symbols-outlined brand-icon" aria-hidden="true">hub</span>
          <span class="brand-name">{{ site.title | escape }}</span>
        </a>
        <p class="brand-tagline">{{ site.description }}</p>
        <nav class="primary-nav" aria-label="Основная навигация">
          <ul class="nav-list">
            <li class="nav-item"><a class="nav-link{% if page.url == '/' %} is-active{% endif %}" href="{{ '/' | relative_url }}">Главная</a></li>
            <li class="nav-item"><a class="nav-link{% if page.url contains '/categories' %} is-active{% endif %}" href="{{ '/categories/' | relative_url }}">Категории</a></li>
            <li class="nav-item"><a class="nav-link{% if page.url contains '/intro' %} is-active{% endif %}" href="{{ '/intro/' | relative_url }}">Проекты</a></li>
            <li class="nav-item nav-item-cta"><a class="nav-link" href="mailto:{{ site.email }}">Связаться</a></li>
          </ul>
        </nav>
      </div>
    </div>
  </header>

  <main id="main-content" class="site-main">
    <div class="container-xl">
      {{ content }}
    </div>
  </main>

  <footer class="site-footer">
    <div class="container-xl footer-content">
      <div>
        <h2 class="footer-title">О блоге</h2>
        <p>Практические заметки о Linux, инфраструктуре, встраиваемых системах и инженерных экспериментах для разработчиков и сисадминов.</p>
      </div>
      <div class="footer-meta">
        <ul class="footer-links">
          <li><a href="{{ '/categories/' | relative_url }}">Все темы</a></li>
          <li><a href="mailto:{{ site.email }}">Написать автору</a></li>
          <li><a href="{{ '/' | relative_url }}#subscribe">Подписка</a></li>
        </ul>
        <p class="footer-copy">© {{ site.time | date: '%Y' }} {{ site.title | escape }}. Сделано с любовью к инженерии.</p>
      </div>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
    crossorigin="anonymous"></script>
  {%- if page.layout == 'post' -%}
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"
    integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script>
    // Fallback to local jQuery if CDN fails
    if (typeof jQuery == 'undefined') {
      console.warn('jQuery CDN failed, using fallback');
      document.write('<script src="{{ "/assets/js/jquery-3.6.0.min.js" | relative_url }}"><\/script>');
    }
  </script>
  <script src="{{ '/assets/js/code.js' | relative_url }}"></script>
  <script src="{{ '/assets/js/clipboard.js' | relative_url }}"></script>
  <script src="{{ '/assets/js/clipboard_copy_component.js' | relative_url }}"></script>
  <script src="{{ '/assets/js/rsvp-reader.js' | relative_url }}" defer></script>
  <script>
    (function () {
      var articleMeta = {
        slug: {{ page.slug | jsonify }} || {{ page.url | jsonify }},
        path: {{ page.url | relative_url | jsonify }},
        categories: {{ page.categories | jsonify }} || [],
        title: {{ page.title | jsonify }}
      };
      var sent = false;
      var read75Sent = false;
      var tryCapture = function () {
        if (sent) return;
        if (window.posthog && typeof window.posthog.capture === 'function') {
          window.posthog.capture('article_view', articleMeta);
          sent = true;
        }
      };
      tryCapture();
      if (!sent) {
        var onLoad = function () {
          tryCapture();
          if (sent) {
            window.removeEventListener('load', onLoad);
            document.removeEventListener('DOMContentLoaded', onLoad);
          }
        };
        window.addEventListener('load', onLoad);
        document.addEventListener('DOMContentLoaded', onLoad);
      }

      var onScrollRead = function () {
        if (read75Sent) return;
        var body = document.body;
        var html = document.documentElement;
        var scrollTop = window.pageYOffset || html.scrollTop || body.scrollTop || 0;
        var viewportHeight = window.innerHeight || html.clientHeight || 0;
        var docHeight = Math.max(body.scrollHeight, body.offsetHeight, html.clientHeight, html.scrollHeight, html.offsetHeight);
        if (!docHeight) return;
        var progress = (scrollTop + viewportHeight) / docHeight;
        if (progress >= 0.75) {
          if (window.posthog && typeof window.posthog.capture === 'function') {
            window.posthog.capture('article_read_75', articleMeta);
          }
          read75Sent = true;
          window.removeEventListener('scroll', onScrollRead);
        }
      };
      window.addEventListener('scroll', onScrollRead, { passive: true });
      onScrollRead();

      var githubClickHandler = function (event) {
        var anchor = event.target && event.target.closest ? event.target.closest('a[href*="github.com/"]') : null;
        if (!anchor) return;
        if (anchor.hostname && anchor.hostname.indexOf('github.com') === -1) return;
        if (!(window.posthog && typeof window.posthog.capture === 'function')) return;
        try {
          var url = new URL(anchor.href);
          var pathParts = url.pathname.split('/').filter(Boolean);
          var repo = pathParts.length >= 2 ? pathParts[0] + '/' + pathParts[1] : null;
          window.posthog.capture('outbound_github_click', {
            repo: repo,
            section: articleMeta.path,
            url: anchor.href
          });
        } catch (e) {
          return;
        }
      };
      document.addEventListener('click', githubClickHandler);
    })();
  </script>
  {%- endif -%}
</body>

</html>
