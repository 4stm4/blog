---
layout: post
title:  "Прошиваем ATmega 328p с помощью USBAsp и avrdude"
date:   2024-05-05 18:18:18 +0500
categories: avr
---
<BR>

## Прошиваем ATmega 320p с помощью USBAsp и avrdude

<img src="{{site.url}}/assets/jpeg/usbasp2.jpeg" width="600px">

Программирование микроконтроллера ATmega328P с помощью программатора USBAsp и утилиты avrdude на компьютере — это довольно прямолинейный процесс, состоящий из нескольких шагов. Вот как это сделать:

### 1. Установите avrdude

avrdude — это программное обеспечение командной строки, используемое для взаимодействия с микроконтроллером. Оно доступно для Linux, macOS и Windows.

- **Для Linux** (Debian/Ubuntu):
  ```bash
  sudo apt-get update
  sudo apt-get install avrdude
  ```
- **Для macOS**, avrdude можно установить через Homebrew:
  ```bash
  brew install avrdude
  ```
- **Для Windows** его можно скачать с официального сайта или использовать в составе Arduino IDE.

### 2. Подключите USBAsp к микроконтроллеру ATmega328P

Убедитесь, что все соединения между USBAsp и вашим микроконтроллером правильно выполнены. Как правило, необходимо соединить следующие контакты: MISO, MOSI, SCK, RESET, VCC и GND. Детальная схема подключения зависит от конкретной платы или макета, с которым вы работаете.
Но удобнее приобрести Zip shield с припаяной обвязкой микроконтроллера.

<img src="{{site.url}}/assets/jpeg/usbasp.jpeg" width="600px">

### 3. Напишите или подготовьте ваш программный код

Убедитесь, что ваша программа для ATmega328P готова к загрузке. Компилируйте её в .hex файл при помощи подходящей среды разработки, например, Atmel Studio, PlatformIO или Arduino IDE.

### 4. Узнайте, какой COM порт использует USBAsp

Этот шаг более актуален для Windows, где устройства подключаются к виртуальным COM-портам.

- **Для Windows**: Проверьте в диспетчере устройств.
- **Для Linux и macOS**: USBAsp обычно не создает виртуальный COM-порт и взаимодействует напрямую через USB, так что этот шаг можно пропустить.

### 5. Прошивка микроконтроллера

Откройте терминал или командную строку и выполните команду avrdude для прошивки микроконтроллера. Пример команды для прошивки может выглядеть так:

```bash
avrdude -c usbasp -p m328p -B4 -U lfuse:w:0xd7:m -U hfuse:w:0xd0:m -U efuse:w:0xfc:m -U peej_lumberjack_via.hex
```

- `-c usbasp` указывает, что используется программатор USBAsp.
- `-p m328p` говорит avrdude, что микроконтроллер — ATmega328P.
- `-U` задает операцию программирования. В данном случае, `flash:w:your_program.hex:i` указывает, что надо записать (`w`) во флеш-память файл `your_program.hex`. Флаг `:i` означает формат Intel Hex.
- `-B` в командной строке avrdude используется для установки значения bitclock, которое фактически контролирует скорость передачи данных между программатором и микроконтроллером во время процесса программирования. Это параметр особенно важен при работе с микроконтроллерами, находящимися в различных состояниях и с разными настройками часов.
Убедитесь, что в команде указан правильный путь к вашему .hex файлу.

### 6. Проверка

После успешной прошивки проверьте работу микроконтроллера согласно логике загруженной программы.

### 7. Зачем нужен флаг -B:

###### Для работы с новыми микроконтроллерами или микроконтроллерами с нестандартными настройками часов:
Новые микроконтроллеры или микроконтроллеры с нестандартными настройками частоты могут требовать более медленной скорости передачи данных для надежного программирования. Это включает в себя микроконтроллеры, которые работают на внутреннем RC-генераторе с низкой частотой или находятся в режиме сниженного энергопотребления.
###### Для восстановления микроконтроллеров:
Если частота микроконтроллера была случайно или намеренно настроена неверно, что привело к потере связи, изменение скорости передачи данных может помочь восстановить связь и перепрограммировать микроконтроллер.
###### Для увеличения скорости программирования:
Иногда, особенно при программировании микроконтроллеров с высокой скоростью часов и при хороших условиях передачи данных, использование более высокой скорости bitclock может ускорить процесс программирования.


 ### 8. Команды -U lfuse:w:0xd7:m -U hfuse:w:0xd0:m -U efuse:w:0xfc:m в контексте avrdude служат для установки параметров fuses (предохранителей) микроконтроллеров AVR. В микроконтроллерах AVR, fuses это специальные биты, которые используются для настройки важных системных параметров, таких как источник тактового сигнала, настройки стартового таймера (watchdog timer), настройка поведения при сбоях и т.д. Эти биты сохраняют свое значение даже после отключения питания микроконтроллера.

Здесь каждая часть команды конфигурирует различные наборы fuses:

-U lfuse:w:0xd7:m устанавливает значения для low fuse (младшего предохранителя). Значение 0xd7 в этом контексте является шестнадцатеричным числом, которое определяет конкретные настройки младшего предохранителя.
-U hfuse:w:0xd0:m устанавливает значения для high fuse (старшего предохранителя) со значением 0xd0.
-U efuse:w:0xfc:m устанавливает значения для extended fuse (расширенного предохранителя) со значением 0xfc.
Каждая из этих настроек (lfuse, hfuse, efuse) контролирует различные аспекты работы микроконтроллера. Например, они могут определять источник тактирования микроконтроллера (внутренний RC осциллятор, внешний кварц и т.д.), включать или отключать защиту от чтения для защиты программного кода, конфигурировать поведение при сбросе и многое другое.

Важно отметить, что неправильная настройка fuse битов может сделать микроконтроллер неработоспособным или затруднить его дальнейшее программирование. Поэтому перед изменением этих настроек следует тщательно изучить соответствующие разделы документации к вашему микроконтроллеру.

Значения 0xd7, 0xd0 и 0xfc были выбраны исходя из конкретной необходимости проекта и должны быть определены согласно технической документации микроконтроллера и требованиям к проекту. Для точной интерпретации этих значений лучше всего обращаться к документации по микроконтроллеру, обычно предоставляемой производителем, где каждый бит настроек предохранителей описан детально.


### Ошибки и устранение неполадок

Если при попытке прошить микроконтроллер возникли ошибки, убедитесь, что:
- Все соединения между USBAsp и микроконтроллером надежно соединены.
- Вы выбрали правильный микроконтроллер в команде avrdude (`-p m328p`).
- Файл .hex доступен и не поврежден.

Также, убедитесь, что USBAsp правильно определяется вашей системой. Если используете Windows, может потребоваться установка драйверов для USBAsp.

