---
layout: post
title:  "Работа с виртуальными пулами через libvirt-python"
date:   2024-06-03 21:21:21 +0500
categories: python
---

## Работа с виртуальными пулами через libvirt-python

Для работы с libvirt и создания пулов хранения через Python, можно использовать библиотеку libvirt-python, которая является Python-обёрткой над библиотекой libvirt API. Пулы хранения используются для организации ресурсов хранения, таких как диски, файловые системы, сетевые файловые системы и так далее, которые виртуальные машины могут использовать для своих нужд. Давайте разберемся, что означают параметры pool_name, pool_type, source_host, source_path при создании пула хранения.

#### Описание параметров:

***pool_name:***

Это уникальное имя пула хранения в рамках одного хоста libvirt. Имя пула используется для идентификации и последующего обращения к нему через API или утилиты управления.

***pool_type:***

Определяет тип хранилища, который будет использоваться. Например, он может быть dir для простой директории на локальной файловой системе, disk для целого физического диска, logical для логического тома LVM, netfs для сетевой файловой системы (например, NFS) и др.

***source_host:***

Определяет имя хоста или IP-адрес сервера, где находится ресурс. Этот параметр особенно важен для таких типов хранения, как netfs, где необходимо указать источник сетевого хранилища.

***source_path:***

Указывает путь к ресурсу на удаленном хосте или локальном хранилище. Для локальных директорий это будет путь к директории на файловой системе. Для сетевых файловых систем это будет путь к ресурсу на сетевом сервере (например, путь к NFS шаре).

Пример создания пула типа dir на Python с использованием libvirt-python:

```python
import libvirt

conn = libvirt.open('qemu:///system')  # Подключение к libvirt

xml_desc = """
<pool type='dir'>
    <name>example_dir_pool</name>
    <target>
        <path>/home/user/virtual_disks</path>
    </target>
</pool>
"""
try:
    pool = conn.storagePoolDefineXML(xml_desc, 0)
    pool.create()  # Активация пула
    pool.setAutostart(1)  # Автозагрузка пула при старте системы
except libvirt.libvirtError as e:
    print(f"An error occurred: {str(e)}")
finally:
    conn.close()
```

Этот код создаёт локальный пул хранения для виртуальных дисков в директории /home/user/virtual_disks . Если бы мы создавали пул для сетевой файловой системы, мы включили бы параметры source_host и source_path в XML-описание.

Подход создания пула для других типов хранилищ будет аналогичным, но с другими параметрами в XML-конфигурации, соответствующими каждому типу хранилища.

Библиотека libvirt поддерживает различные типы пулов хранения для организации ресурсов, доступных для виртуальных машин. Они определяют различные способы хранения и доступа к данным. Ниже приведены некоторые из наиболее распространенных `pool_type` в libvirt:

1. **dir**:
   - Этот тип пула ссылается на директорию в файловой системе хоста. Файлы в этой директории могут использоваться для хранения дисков виртуальных машин.
```xml
<pool type='dir'>
  <name>mydirpool</name>
  <source>
    <path>/var/lib/libvirt/images</path>
  </source>
</pool>
```

2. **fs**:
   - Позволяет использовать сетевые файловые системы (NFS, GlusterFS и другие).
```xml
<pool type='fs'>
  <name>mynfspool</name>
  <source>
    <host name='nfsserver.example.com'/>
    <path>/mnt/nfs_share</path>
  </source>
</pool>
```

3. **netfs**:
   - Этот тип пула обеспечивает доступ к сетевым файловым системам через протоколы, такие как NFS или CIFS/SMB.
```xml
<pool type='netfs'>
  <name>mynetfspool</name>
  <source>
    <host name='nfsserver.example.com'/>
    <path>/mnt/nfs_share</path>
  </source>
</pool>
```

4. **logical**:
   - Поддерживает логические разделы LVM (Logical Volume Manager).
```xml
<pool type='logical'>
  <name>mylogicalpool</name>
  <source>
    <device path='/dev/vg_name'/>
  </source>
</pool>
```

5. **disk**:
 - Этот тип предназначен для работы с физическими устройствами носителей, такими как жесткие диски.
```xml
<pool type='disk'>
  <name>mydiskpool</name>
  <source>
    <device path='/dev/sdb'/>
  </source>
</pool>
```

6. **iscsi**:
   - Позволяет использовать iSCSI устройства для хранения данных виртуальных машин.
```xml
<pool type='iscsi'>
  <name>myiscsipool</name>
  <source>
    <host name='iscsihost.example.com'/>
    <device path='iqn.2017-03.org.example:disk1'/>
  </source>
</pool>
```

7. **scsi**:
   - Данный тип пула предоставляет возможность использовать устройства SCSI.
```xml
<pool type='scsi'>
  <name>myscsipool</name>
  <source>
    <adapter type='scsi_host' name='host1'/>
    <target dev='sda'/>
  </source>
</pool>
```

8. **mpath**:
    - Этот тип пула позволяет использовать устройства mpath (MultiPath) для хранения данных.
```xml
<pool type='mpath'>
  <name>mympathpool</name>
  <source>
    <adapter type='fc_host' name='host1'/>
    <device name='mpath/mpath1'/>
  </source>
</pool>
```


### В рамках управления пулами виртуальных ресурсов с помощью libvirt вы можете выполнять различные операции. Ниже приведены типичные операции, которые можно применять к пулу:

***Создание пула***: Создание нового пула для хранения виртуальных машин или дисков.

***Удаление пула***: Удаление существующего пула и освобождение занятых им ресурсов.

***Активация/деактивация пула***: Активация или деактивация пула, что позволяет использовать или приостановить его использование.

***Назначение прав доступа***: Настройка прав доступа к пулу для различных пользователей или групп.

***Добавление/удаление ресурсов из пула***: Добавление новых ресурсов в пул или удаление существующих ресурсов из него.

***Изменение параметров пула***: Изменение параметров пула, например, изменение пути к источнику хранения или прав доступа.

***Обновление пула***: Обновление информации о пуле, чтобы отразить последние изменения и обновления.

***Мониторинг использования***: Отслеживание использования ресурсов в пуле.

***Резервное копирование и восстановление***: Создание резервных копий пула и восстановление из них.

***Перемещение пула***: Перемещение пула на другой хост или миграция его ресурсов на другое хранилище.

Это лишь некоторые из типовых операций, которые могут выполняться с пулами виртуальных ресурсов. Каждая операция включает в себя определенные шаги и методы, которые зависят от используемой технологии виртуализации и инструментов управления ресурсами.